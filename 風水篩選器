<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¢¨æ°´ç¯©é¸å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Microsoft JhengHei', sans-serif; }
        
        /* å½±åƒå±¤ */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* UI å±¤ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* é ‚éƒ¨è³‡è¨Š */
        .top-bar { 
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); 
            padding: 15px; text-align: center; color: #0f0; text-shadow: 0 0 5px #0f0;
        }
        .compass-val { font-size: 3rem; font-weight: bold; }
        .compass-label { font-size: 1.2rem; color: #fff; }
        
        /* åº•éƒ¨æ§åˆ¶èˆ‡ç‹€æ…‹ */
        .bottom-bar { 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            padding: 20px; pointer-events: auto; text-align: center;
        }
        
        button { 
            background: #0f0; color: #000; border: none; padding: 15px 30px; 
            font-size: 1.2rem; font-weight: bold; border-radius: 30px; 
            box-shadow: 0 0 15px #0f0; cursor: pointer; transition: 0.3s;
        }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #aaa; box-shadow: none; }

        .status-msg { color: #0ff; margin-bottom: 10px; font-size: 0.9rem; }
        
        /* é¢¨æ°´è­¦å‘Šå½ˆçª— */
        #alert-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8); color: white; padding: 20px;
            border-radius: 10px; text-align: center; display: none; z-index: 20;
            border: 2px solid #fff; box-shadow: 0 0 20px red; pointer-events: none;
        }
        .safe-box { background: rgba(0, 255, 0, 0.8) !important; box-shadow: 0 0 20px green !important; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="alert-box">
        <h2 id="alert-title">ç…æ°£åµæ¸¬</h2>
        <p id="alert-desc">å…§å®¹...</p>
    </div>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="compass-val" id="deg">0Â°</div>
            <div class="compass-label" id="dir">ç­‰å¾…æ ¡æ­£</div>
            <div style="font-size: 0.8rem; margin-top:5px; color:#aaa;">AI ç‹€æ…‹: <span id="ai-status">è¼‰å…¥ä¸­...</span></div>
        </div>

        <div class="bottom-bar">
            <div class="status-msg" id="status-text">è«‹é»æ“ŠæŒ‰éˆ•å•Ÿå‹•ç³»çµ±</div>
            <button id="btn-start" onclick="initApp()">ğŸ‘‰ å•Ÿå‹• AI é¢¨æ°´å¸«</button>
            
            <div style="margin-top:15px; display:flex; align-items:center; gap:10px; color:#aaa; font-size:0.8rem;">
                <span>ç¾…ç›¤æ ¡æ­£:</span>
                <input type="range" min="-180" max="180" value="0" style="flex:1;" oninput="updateOffset(this.value)">
            </div>
        </div>
    </div>

    <script>
    let model = null;
    let currentHeading = 0;
    let offset = 0;
    let lastAlertTime = 0;

    // é™¤éŒ¯æ—¥èªŒåŠŸèƒ½
    function debugLog(msg) {
        console.log(msg);
        // å¦‚æœæ‚¨æƒ³åœ¨æ‰‹æ©Ÿç•«é¢ä¸Šçœ‹åˆ°éŒ¯èª¤ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢é€™è¡Œçš„è¨»è§£
        // document.getElementById('status-text').innerText = msg;
    }

    // 1. åˆå§‹åŒ–ç³»çµ± (å¿…é ˆç”±æŒ‰éˆ•é»æ“Šè§¸ç™¼ï¼)
    async function initApp() {
        const btn = document.getElementById('btn-start');
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨è«‹æ±‚æ¬Šé™...";

        // --- A. å¼·åˆ¶è«‹æ±‚ç¾…ç›¤æ¬Šé™ (iOS é—œéµæ­¥é©Ÿ) ---
        // å¿…é ˆå…ˆè«‹æ±‚æ¬Šé™ï¼Œå†è™•ç†ç›¸æ©Ÿèˆ‡ AI
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            try {
                const permissionState = await DeviceOrientationEvent.requestPermission();
                if (permissionState === 'granted') {
                    window.addEventListener('deviceorientation', handleOrientation);
                    debugLog("iOS ç¾…ç›¤æ¬Šé™å·²å–å¾—");
                } else {
                    alert("âš ï¸ æ¬Šé™è¢«æ‹’çµ•ï¼è«‹é‡æ–°æ•´ç†ç¶²é ï¼Œä¸¦å‹™å¿…é»é¸ã€Œå…è¨±ã€ã€‚");
                    btn.disabled = false;
                    return;
                }
            } catch (error) {
                console.error(error);
                // é iOS 13+ è£ç½®æœƒå ±éŒ¯ï¼Œç›´æ¥å¿½ç•¥ï¼Œé€²å…¥ Android æµç¨‹
            }
        } else {
            // Android æµç¨‹ï¼šå˜—è©¦å…©ç¨®ç›£è½æ¨¡å¼
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
                debugLog("ä½¿ç”¨ Android çµ•å°æ–¹ä½");
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                debugLog("ä½¿ç”¨æ¨™æº–æ–¹ä½äº‹ä»¶");
            }
        }

        // --- B. å•Ÿå‹•ç›¸æ©Ÿ ---
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }
            });
            const video = document.getElementById('video');
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                resizeCanvas();
            };
        } catch (err) {
            alert("âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err);
            return;
        }

        // --- C. è¼‰å…¥ AI ---
        document.getElementById('ai-status').innerText = "æ¨¡å‹è¼‰å…¥ä¸­...";
        try {
            model = await cocoSsd.load();
            document.getElementById('ai-status').innerText = "âœ… AI é‹ä½œä¸­";
            btn.style.display = 'none';
            document.getElementById('status-text').innerText = "ç¾…ç›¤å·²å•Ÿå‹•ï¼Œè«‹æƒæç’°å¢ƒ";
            detectFrame();
        } catch (err) {
            alert("AI æ¨¡å‹è¼‰å…¥å¤±æ•—");
        }
    }

    // 2. ç¾…ç›¤è™•ç†æ ¸å¿ƒ (ç›¸å®¹æ€§ä¿®æ­£ç‰ˆ)
    function handleOrientation(event) {
        let h = null;

        // å„ªå…ˆé †åº 1: iOS æŒ‡å—é‡
        if (event.webkitCompassHeading) {
            h = event.webkitCompassHeading;
        } 
        // å„ªå…ˆé †åº 2: Android çµ•å°æ–¹ä½ (absolute ç‚º true)
        else if (event.absolute === true && event.alpha !== null) {
            h = 360 - event.alpha;
        }
        // å„ªå…ˆé †åº 3: æ™®é€š alpha (å¯èƒ½åªæ˜¯ç›¸å°å€¼ï¼Œéœ€è¦æ ¡æ­£)
        else if (event.alpha !== null) {
            h = 360 - event.alpha;
        }

        // å¦‚æœæŠ“ä¸åˆ°æ•¸å€¼ï¼Œå°±ä¸æ›´æ–°
        if (h === null) return;

        // è¨ˆç®—èˆ‡é¡¯ç¤º
        currentHeading = (h + offset + 360) % 360;
        document.getElementById('deg').innerText = Math.round(currentHeading) + "Â°";
        document.getElementById('dir').innerText = getDirLabel(currentHeading);
    }

    function updateOffset(val) { offset = parseInt(val); }

    function getDirLabel(deg) {
        const dirs = ['åŒ—(å)', 'æ±åŒ—(è‰®)', 'æ±(éœ‡)', 'æ±å—(å·½)', 'å—(é›¢)', 'è¥¿å—(å¤)', 'è¥¿(å…Œ)', 'è¥¿åŒ—(ä¹¾)'];
        return dirs[Math.round(deg / 45) % 8];
    }

    // 3. AI åµæ¸¬èˆ‡ç¹ªåœ– (ç¶­æŒåŸæ¨£)
    async function detectFrame() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        if (video.readyState === 4 && model) {
            const predictions = await model.detect(video);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            predictions.forEach(prediction => {
                const type = checkFengShuiObject(prediction.class);
                if (type && prediction.score > 0.6) {
                    const [x, y, width, height] = prediction.bbox;
                    ctx.strokeStyle = type.color;
                    ctx.lineWidth = 4;
                    ctx.strokeRect(x, y, width, height);
                    ctx.fillStyle = type.color;
                    ctx.font = '18px Arial';
                    ctx.fillText(`${type.label}`, x, y > 10 ? y - 5 : 10);
                    checkFengShuiLogic(type.key);
                }
            });
        }
        requestAnimationFrame(detectFrame);
    }

    function checkFengShuiObject(className) {
        const map = {
            'toilet': { key: 'toilet', label: 'ğŸš½ é¦¬æ¡¶', color: '#FF00FF' },
            'microwave': { key: 'kitchen', label: 'ğŸ”¥ å»šæˆ¿', color: '#FF4500' },
            'oven': { key: 'kitchen', label: 'ğŸ”¥ å»šæˆ¿', color: '#FF4500' },
            'refrigerator': { key: 'kitchen', label: 'ğŸ”¥ å»šæˆ¿', color: '#FF4500' },
            'bed': { key: 'bed', label: 'ğŸ›ï¸ è‡¥å®¤', color: '#00FF00' },
            'couch': { key: 'bed', label: 'ğŸ›‹ï¸ æ²™ç™¼', color: '#00FF00' }
        };
        return map[className] || null;
    }

    function checkFengShuiLogic(objKey) {
        const now = Date.now();
        if (now - lastAlertTime < 3000) return;

        let msg = null;
        let isBad = false;
        const deg = currentHeading;

        if (objKey === 'kitchen') {
            if (deg >= 292.5 && deg <= 337.5) {
                msg = "âš ï¸ è­¦å‘Šï¼šç«ç‡’å¤©é–€ï¼(è¥¿åŒ—æ–¹)";
                isBad = true;
            }
        } else if (objKey === 'toilet') {
            if ((deg >= 22.5 && deg <= 67.5) || (deg >= 202.5 && deg <= 247.5)) {
                msg = "âš ï¸ è­¦å‘Šï¼šé¬¼é–€å»ï¼(æ±åŒ—/è¥¿å—)";
                isBad = true;
            }
        }

        if (msg) {
            showAlert(msg, isBad);
            lastAlertTime = now;
        }
    }

    function showAlert(text, isBad) {
        const box = document.getElementById('alert-box');
        const title = document.getElementById('alert-title');
        const desc = document.getElementById('alert-desc');
        box.className = isBad ? '' : 'safe-box';
        title.innerText = isBad ? "ç…æ°£åµæ¸¬" : "å‰ä½åµæ¸¬";
        desc.innerText = text;
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 3000);
    }

    function resizeCanvas() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        if(video) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
    }
    window.addEventListener('resize', resizeCanvas);
</script>
</body>
</html>
 
