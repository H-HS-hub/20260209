<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¢¨æ°´ç¯©é¸å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Microsoft JhengHei', sans-serif; }
        
        /* å½±åƒå±¤ */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* UI å±¤ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* é ‚éƒ¨è³‡è¨Š */
        .top-bar { 
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); 
            padding: 15px; text-align: center; color: #0f0; text-shadow: 0 0 5px #0f0;
        }
        .compass-val { font-size: 3rem; font-weight: bold; }
        .compass-label { font-size: 1.2rem; color: #fff; }
        
        /* åº•éƒ¨æ§åˆ¶èˆ‡ç‹€æ…‹ */
        .bottom-bar { 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            padding: 20px; pointer-events: auto; text-align: center;
        }
        
        button { 
            background: #0f0; color: #000; border: none; padding: 15px 30px; 
            font-size: 1.2rem; font-weight: bold; border-radius: 30px; 
            box-shadow: 0 0 15px #0f0; cursor: pointer; transition: 0.3s;
        }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #aaa; box-shadow: none; }

        .status-msg { color: #0ff; margin-bottom: 10px; font-size: 0.9rem; }
        
        /* é¢¨æ°´è­¦å‘Šå½ˆçª— */
        #alert-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8); color: white; padding: 20px;
            border-radius: 10px; text-align: center; display: none; z-index: 20;
            border: 2px solid #fff; box-shadow: 0 0 20px red; pointer-events: none;
        }
        .safe-box { background: rgba(0, 255, 0, 0.8) !important; box-shadow: 0 0 20px green !important; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="alert-box">
        <h2 id="alert-title">ç…æ°£åµæ¸¬</h2>
        <p id="alert-desc">å…§å®¹...</p>
    </div>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="compass-val" id="deg">0Â°</div>
            <div class="compass-label" id="dir">ç­‰å¾…æ ¡æ­£</div>
            <div style="font-size: 0.8rem; margin-top:5px; color:#aaa;">AI ç‹€æ…‹: <span id="ai-status">è¼‰å…¥ä¸­...</span></div>
        </div>

        <div class="bottom-bar">
            <div class="status-msg" id="status-text">è«‹é»æ“ŠæŒ‰éˆ•å•Ÿå‹•ç³»çµ±</div>
            <button id="btn-start" onclick="initApp()">ğŸ‘‰ å•Ÿå‹• AI é¢¨æ°´å¸«</button>
            
            <div style="margin-top:15px; display:flex; align-items:center; gap:10px; color:#aaa; font-size:0.8rem;">
                <span>ç¾…ç›¤æ ¡æ­£:</span>
                <input type="range" min="-180" max="180" value="0" style="flex:1;" oninput="updateOffset(this.value)">
            </div>
        </div>
    </div>

    <script>
        let model = null;
        let isDetecting = false;
        let currentHeading = 0;
        let offset = 0;
        let lastAlertTime = 0; // é¿å…è­¦å‘Šä¸€ç›´è·³

        // 1. åˆå§‹åŒ–ç³»çµ±
        async function initApp() {
            const btn = document.getElementById('btn-start');
            btn.disabled = true;
            btn.innerText = "ç³»çµ±å•Ÿå‹•ä¸­...";

            // A. å•Ÿå‹•ç›¸æ©Ÿ
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // ç­‰å¾…å½±åƒè¼‰å…¥å®Œæˆå†è¨­å®š Canvas å°ºå¯¸
                video.onloadedmetadata = () => {
                    video.play();
                    resizeCanvas();
                };
            } catch (err) {
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err);
                return;
            }

            // B. å•Ÿå‹•ç¾…ç›¤
            setupCompass();

            // C. è¼‰å…¥ AI æ¨¡å‹
            document.getElementById('ai-status').innerText = "ä¸‹è¼‰æ¨¡å‹ä¸­ (ç´„ 10MB)...";
            try {
                model = await cocoSsd.load();
                document.getElementById('ai-status').innerText = "âœ… AI é‹ä½œä¸­";
                btn.style.display = 'none'; // éš±è—æŒ‰éˆ•
                document.getElementById('status-text').innerText = "è«‹å°‡é¡é ­å°æº–ï¼šé¦¬æ¡¶ã€ç“¦æ–¯çˆã€åºŠ";
                
                // é–‹å§‹åµæ¸¬è¿´åœˆ
                detectFrame();
            } catch (err) {
                alert("æ¨¡å‹è¼‰å…¥å¤±æ•—: " + err);
                document.getElementById('ai-status').innerText = "âŒ æ¨¡å‹éŒ¯èª¤";
            }
        }

        // 2. ç¾…ç›¤è¨­å®š (æ•´åˆç‰ˆ)
        function setupCompass() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(r => { if (r === 'granted') window.addEventListener('deviceorientation', handleOrientation); })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(e) {
            let h = e.webkitCompassHeading || (e.alpha ? 360 - e.alpha : 0);
            // ç°¡å–®å¹³æ»‘èˆ‡æ ¡æ­£
            currentHeading = (h + offset + 360) % 360;
            
            document.getElementById('deg').innerText = Math.round(currentHeading) + "Â°";
            document.getElementById('dir').innerText = getDirLabel(currentHeading);
        }

        function updateOffset(val) { offset = parseInt(val); }

        function getDirLabel(deg) {
            const dirs = ['åŒ—(å)', 'æ±åŒ—(è‰®)', 'æ±(éœ‡)', 'æ±å—(å·½)', 'å—(é›¢)', 'è¥¿å—(å¤)', 'è¥¿(å…Œ)', 'è¥¿åŒ—(ä¹¾)'];
            return dirs[Math.round(deg / 45) % 8];
        }

        // 3. AI åµæ¸¬è¿´åœˆ
        async function detectFrame() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            if (video.readyState === 4) { // ç¢ºèªå½±åƒå¯ç”¨
                const predictions = await model.detect(video);
                
                // æ¸…ç©ºç•«å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                predictions.forEach(prediction => {
                    // åªéæ¿¾æˆ‘å€‘æ„Ÿèˆˆè¶£çš„é¢¨æ°´ç‰©ä»¶
                    const type = checkFengShuiObject(prediction.class);
                    
                    if (type && prediction.score > 0.6) {
                        // ç•«æ¡†æ¡†
                        const [x, y, width, height] = prediction.bbox;
                        ctx.strokeStyle = type.color;
                        ctx.lineWidth = 4;
                        ctx.strokeRect(x, y, width, height);

                        // ç•«æ–‡å­—
                        ctx.fillStyle = type.color;
                        ctx.font = '18px Arial';
                        ctx.fillText(`${type.label} (${Math.round(prediction.score*100)}%)`, x, y > 10 ? y - 5 : 10);

                        // è§¸ç™¼é¢¨æ°´åˆ¤æ–·
                        checkFengShuiLogic(type.key);
                    }
                });
            }
            requestAnimationFrame(detectFrame);
        }

        // 4. å®šç¾©é¢¨æ°´ç‰©ä»¶èˆ‡é¡è‰²
        function checkFengShuiObject(className) {
            // COCO-SSD çš„é¡åˆ¥åç¨±æ˜ å°„
            const map = {
                'toilet': { key: 'toilet', label: 'ğŸš½ é¦¬æ¡¶ (ç©¢æ°£)', color: '#FF00FF' }, // æ´‹ç´…è‰²
                'microwave': { key: 'kitchen', label: 'ğŸ”¥ å»šæˆ¿ (ç«æ°£)', color: '#FF4500' }, // æ©˜ç´…è‰²
                'oven': { key: 'kitchen', label: 'ğŸ”¥ å»šæˆ¿ (ç«æ°£)', color: '#FF4500' },
                'refrigerator': { key: 'kitchen', label: 'ğŸ”¥ å»šæˆ¿ (è²¡åº«)', color: '#FF4500' },
                'sink': { key: 'kitchen', label: 'ğŸ’§ æ°´æ§½ (æ°´æ°£)', color: '#00FFFF' },
                'bed': { key: 'bed', label: 'ğŸ›ï¸ è‡¥å®¤ (å®‰ç¥)', color: '#00FF00' }, // ç¶ è‰²
                'couch': { key: 'bed', label: 'ğŸ›‹ï¸ æ²™ç™¼ (ä¼‘æ¯)', color: '#00FF00' } // æŠŠæ²™ç™¼ä¹Ÿè¦–ç‚ºä¼‘æ¯å€
            };
            return map[className] || null;
        }

        // 5. é¢¨æ°´å‰å‡¶é‚è¼¯æ ¸å¿ƒ
        function checkFengShuiLogic(objKey) {
            const now = Date.now();
            if (now - lastAlertTime < 3000) return; // å†·å»æ™‚é–“ 3 ç§’

            let msg = null;
            let isBad = false;

            // å–å¾—ç›®å‰æ–¹ä½ (å‡è¨­é¡é ­çœ‹å‡ºå»çš„æ–¹å‘å°±æ˜¯è©²ç‰©ä»¶çš„æ–¹ä½)
            const deg = currentHeading;

            if (objKey === 'kitchen') {
                // ç«ç‡’å¤©é–€ï¼šå»šæˆ¿åœ¨è¥¿åŒ— (292.5 ~ 337.5)
                if (deg >= 292.5 && deg <= 337.5) {
                    msg = "âš ï¸ è­¦å‘Šï¼šç«ç‡’å¤©é–€ï¼\nå»šæˆ¿ä½æ–¼è¥¿åŒ—æ–¹ï¼Œç«å‰‹é‡‘ï¼Œå¤§å‡¶ã€‚";
                    isBad = true;
                }
            } else if (objKey === 'toilet') {
                // é¬¼é–€ï¼šæ±åŒ— (22.5~67.5) æˆ– è¥¿å— (202.5~247.5)
                if ((deg >= 22.5 && deg <= 67.5) || (deg >= 202.5 && deg <= 247.5)) {
                    msg = "âš ï¸ è­¦å‘Šï¼šé¬¼é–€å»ï¼\nå»æ‰€ä½æ–¼æ±åŒ—/è¥¿å—ï¼Œèšé™°æ°£ã€‚";
                    isBad = true;
                } else if (deg >= 157.5 && deg <= 202.5) {
                    msg = "âš ï¸ æé†’ï¼šæ°´ç«ç›¸å‰‹\nå»æ‰€ä½æ–¼å—æ–¹(é›¢å®®)ï¼Œå±¬ç«ï¼Œå®¹æ˜“å¼•ç™¼çœ¼ç–¾æˆ–å¿ƒè¡€ç®¡å•é¡Œã€‚";
                    isBad = true;
                }
            } else if (objKey === 'bed') {
                // ç°¡å–®åˆ¤æ–·ï¼šåºŠé ­æœè¥¿ (247.5 ~ 292.5)
                // æ³¨æ„ï¼šé€™è£¡æ˜¯é¡é ­çœ‹åºŠï¼Œæ‰€ä»¥ä»£è¡¨åºŠåœ¨è¥¿æ–¹ã€‚å¦‚æœè¦æŠŠé‚è¼¯æ”¹æˆã€ŒåºŠé ­æœå‘ã€ï¼Œéœ€è¦æ›´è¤‡é›œçš„åˆ¤æ–·ã€‚
                // é€™è£¡å…ˆç¤ºç¯„ï¼šåºŠä½åœ¨è¥¿æ–¹
                if (deg >= 247.5 && deg <= 292.5) {
                    msg = "âœ… åºŠä½ï¼šä½æ–¼è¥¿æ–¹(å…Œå®®)\nåˆ©æ±‚è²¡èˆ‡å£æ‰ï¼Œé©åˆæ¥­å‹™ã€‚";
                }
            }

            if (msg) {
                showAlert(msg, isBad);
                lastAlertTime = now;
            }
        }

        function showAlert(text, isBad) {
            const box = document.getElementById('alert-box');
            const title = document.getElementById('alert-title');
            const desc = document.getElementById('alert-desc');
            
            box.className = isBad ? '' : 'safe-box'; // åˆ‡æ›é¡è‰²
            title.innerText = isBad ? "ç…æ°£åµæ¸¬" : "å‰ä½åµæ¸¬";
            desc.innerText = text;
            
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }

        function resizeCanvas() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html>
 
